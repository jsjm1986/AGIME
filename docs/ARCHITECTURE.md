# AGIME 技术架构

> 本文档面向开发者和技术爱好者，详细介绍 AGIME 的技术架构和设计理念。

## 目录

- [整体架构](#整体架构)
- [核心组件](#核心组件)
- [数据流](#数据流)
- [安全模型](#安全模型)
- [扩展机制](#扩展机制)
- [跨平台支持](#跨平台支持)

---

## 整体架构

AGIME 采用分层架构设计，将关注点分离，确保系统的可维护性和可扩展性。

```
┌─────────────────────────────────────────────────────────┐
│                      用户界面层                          │
│              (Electron + React + TypeScript)            │
├─────────────────────────────────────────────────────────┤
│                      应用服务层                          │
│                    (Rust Backend)                       │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │
│  │ 会话管理  │ │ 食谱引擎  │ │ 调度系统  │ │ 记忆系统  │  │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘  │
├─────────────────────────────────────────────────────────┤
│                      AI 核心层                          │
│  ┌──────────────────────────────────────────────────┐  │
│  │              Agent 执行引擎                        │  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐            │  │
│  │  │ 规划器   │ │ 执行器   │ │ 观察器   │            │  │
│  │  └─────────┘ └─────────┘ └─────────┘            │  │
│  └──────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────┤
│                      模型适配层                          │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │
│  │ OpenAI   │ │ Anthropic│ │ 国产模型  │ │ Ollama   │  │
│  │ 兼容接口  │ │ 兼容接口  │ │ 兼容接口  │ │ 本地接口  │  │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘  │
├─────────────────────────────────────────────────────────┤
│                      工具执行层                          │
│                    (MCP Protocol)                       │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │
│  │Developer │ │Computer  │ │Playwright│ │ Memory   │  │
│  │ 开发工具  │ │Controller│ │ 浏览器   │ │ 记忆存储  │  │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘  │
└─────────────────────────────────────────────────────────┘
```

---

## 核心组件

### 1. 用户界面层

**技术栈**: Electron + React + TypeScript + Tailwind CSS

- **主窗口**: 对话界面、消息渲染、输入处理
- **侧边栏**: 会话管理、食谱列表、设置入口
- **设置面板**: 模型配置、扩展管理、偏好设置
- **系统托盘**: 后台运行、快捷操作

### 2. 应用服务层

**技术栈**: Rust + Axum

- **会话管理器**: 管理对话上下文、历史记录、状态持久化
- **食谱引擎**: 解析、存储、执行可复用的工作流
- **调度系统**: Cron 表达式解析、定时任务触发、后台执行
- **记忆系统**: 用户偏好存储、上下文记忆、知识图谱

### 3. AI 核心层

Agent 执行引擎是 AGIME 的核心，采用 ReAct (Reasoning + Acting) 模式：

```
┌─────────────────────────────────────────┐
│              Agent 循环                  │
│                                         │
│   ┌─────────┐                          │
│   │ 用户输入 │                          │
│   └────┬────┘                          │
│        ▼                               │
│   ┌─────────┐                          │
│   │  思考    │ ◄─────────────┐         │
│   │(Reason) │               │         │
│   └────┬────┘               │         │
│        ▼                    │         │
│   ┌─────────┐               │         │
│   │  行动    │               │         │
│   │ (Act)   │               │         │
│   └────┬────┘               │         │
│        ▼                    │         │
│   ┌─────────┐               │         │
│   │  观察    │───────────────┘         │
│   │(Observe)│                          │
│   └────┬────┘                          │
│        ▼                               │
│   ┌─────────┐                          │
│   │ 完成/继续│                          │
│   └─────────┘                          │
└─────────────────────────────────────────┘
```

### 4. 模型适配层

统一的模型接口抽象，支持多种后端：

```rust
trait ModelProvider {
    async fn chat(&self, messages: Vec<Message>) -> Result<Response>;
    async fn stream(&self, messages: Vec<Message>) -> Result<Stream>;
    fn supports_tools(&self) -> bool;
    fn supports_vision(&self) -> bool;
}
```

**支持的协议**:
- OpenAI API 兼容协议（大多数模型服务商）
- Anthropic API 协议
- Ollama 本地协议

### 5. 工具执行层

基于 MCP (Model Context Protocol) 标准的扩展系统：

```
┌─────────────────────────────────────────┐
│              MCP Host                    │
│           (AGIME Core)                   │
├─────────────────────────────────────────┤
│    │           │           │            │
│    ▼           ▼           ▼            │
│ ┌─────┐    ┌─────┐    ┌─────┐          │
│ │ MCP │    │ MCP │    │ MCP │          │
│ │Server│   │Server│   │Server│  ...    │
│ │  A  │    │  B  │    │  C  │          │
│ └─────┘    └─────┘    └─────┘          │
│                                         │
│ 内置扩展 + 用户自定义扩展               │
└─────────────────────────────────────────┘
```

---

## 数据流

### 用户请求处理流程

```
用户输入
    │
    ▼
┌─────────────────┐
│   前端处理       │  消息格式化、附件处理
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   后端路由       │  会话识别、权限检查
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   上下文构建     │  历史消息、系统提示、工具定义
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   模型调用       │  发送请求到 AI 模型
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   响应解析       │  提取文本、工具调用
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌───────┐ ┌───────┐
│ 文本  │ │ 工具  │
│ 输出  │ │ 调用  │
└───────┘ └───┬───┘
              │
              ▼
        ┌───────────┐
        │ 执行工具   │
        │ 返回结果   │
        └─────┬─────┘
              │
              ▼
        ┌───────────┐
        │ 继续对话   │  (循环直到完成)
        └───────────┘
```

### 数据存储

```
~/.config/agime/
├── config.yaml          # 全局配置
├── profiles/            # 模型配置
│   └── default.yaml
├── sessions/            # 会话历史
│   └── {session_id}/
│       ├── messages.json
│       └── metadata.json
├── recipes/             # 食谱存储
│   └── {recipe_id}.yaml
├── memory/              # 记忆数据
│   └── knowledge.db
└── extensions/          # 扩展配置
    └── {extension_id}/
```

---

## 安全模型

### 权限层级

AGIME 采用四级权限控制：

| 级别 | 名称 | 描述 | 需确认 |
|------|------|------|--------|
| 0 | 只读 | 读取文件、查看信息 | 否 |
| 1 | 低风险 | 创建文件、网络请求 | 可配置 |
| 2 | 中风险 | 修改文件、执行命令 | 是 |
| 3 | 高风险 | 删除文件、系统操作 | 强制确认 |

### 工作模式与权限

```
┌─────────────┬─────────────────────────────────┐
│   工作模式   │          权限行为                │
├─────────────┼─────────────────────────────────┤
│ 自主模式    │ 所有操作自动执行                  │
│ 智能模式    │ 级别 2+ 需确认                   │
│ 手动模式    │ 所有操作需确认                   │
│ 聊天模式    │ 禁止所有工具调用                  │
└─────────────┴─────────────────────────────────┘
```

### 沙箱隔离

- **进程隔离**: MCP 扩展运行在独立进程
- **路径限制**: 可配置允许访问的目录范围
- **网络控制**: 可配置允许访问的域名
- **超时机制**: 工具执行超时自动终止

---

## 扩展机制

### MCP 协议

AGIME 基于 Model Context Protocol 实现扩展系统：

```yaml
# 扩展定义示例
name: my-extension
version: 1.0.0
description: 自定义扩展

tools:
  - name: my_tool
    description: 工具描述
    parameters:
      type: object
      properties:
        param1:
          type: string
          description: 参数说明

resources:
  - name: my_resource
    description: 资源描述
    uri: file:///path/to/resource
```

### 扩展类型

1. **内置扩展**: 随 AGIME 安装，核心功能
2. **官方扩展**: 官方维护，可选安装
3. **社区扩展**: 第三方开发，需审核
4. **私有扩展**: 用户自行开发

### 扩展通信

```
AGIME Core                    MCP Server
    │                             │
    │  ──── initialize ────►      │
    │  ◄─── capabilities ────     │
    │                             │
    │  ──── tools/list ────►      │
    │  ◄─── tool definitions ──   │
    │                             │
    │  ──── tools/call ────►      │
    │  ◄─── result ────           │
    │                             │
```

---

## 跨平台支持

### 技术实现

| 平台 | 打包格式 | 特殊处理 |
|------|----------|----------|
| Windows | `.exe` / `.zip` | 注册表、开机启动 |
| macOS | `.dmg` / `.zip` | 签名公证、沙箱 |
| Linux | `.deb` / `.rpm` / `.tar.gz` | 多发行版兼容 |

### 平台适配

- **路径处理**: 统一使用平台无关的路径 API
- **快捷键**: 根据平台自动适配 (Cmd/Ctrl)
- **系统集成**: 托盘图标、通知、开机启动
- **原生功能**: 文件对话框、系统主题

---

## 性能优化

### 启动优化

- 延迟加载非关键模块
- 预编译 Rust 核心
- 缓存扩展元数据

### 运行时优化

- 消息流式传输，实时显示
- 工具结果增量更新
- 历史消息分页加载

### 内存管理

- 会话上下文窗口滑动
- 大文件分块处理
- 空闲时释放资源

---

## 开发指南

如果你想参与 AGIME 开发或构建自己的扩展，请参阅：

- [开发环境搭建](./DEVELOPMENT.md)
- [扩展开发指南](./EXTENSION_GUIDE.md)
- [贡献指南](../CONTRIBUTING.md)

---

<p align="center">
  <a href="../README.md">← 返回主页</a>
</p>
