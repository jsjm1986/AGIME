name: Build AGIME All Platforms

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: false
        type: string
      create_release:
        description: 'Create GitHub Release after build'
        required: false
        type: boolean
        default: false
      release_tag:
        description: 'Release tag (e.g., v1.0.0) - required if create_release is true'
        required: false
        type: string

# æ·»åŠ æƒé™é…ç½®ï¼Œå…è®¸åˆ›å»º Release
permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================
  # Windows Build (x64) - ZIP (Docker Cross-Compilation)
  # ============================================
  build-windows-x64:
    runs-on: ubuntu-latest
    name: Build Windows (x64 ZIP)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: ui/desktop/package-lock.json

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: windows-x64

      - name: Build Windows executable using Docker cross-compilation
        run: |
          echo "ðŸš€ Building Windows executable with Docker cross-compilation..."

          # Create cache directories
          mkdir -p ~/.cargo/registry ~/.cargo/git

          # Use Docker for cross-compilation
          docker run --rm \
            -v "$(pwd)":/usr/src/myapp \
            -v "$HOME/.cargo/registry":/usr/local/cargo/registry \
            -v "$HOME/.cargo/git":/usr/local/cargo/git \
            -w /usr/src/myapp \
            rust:latest \
            bash -c "
              set -e
              echo '=== Setting up Rust environment ==='
              export CARGO_HOME=/usr/local/cargo
              export PATH=/usr/local/cargo/bin:\$PATH

              echo 'ðŸ“¦ Installing Windows cross-compilation target...'
              rustup target add x86_64-pc-windows-gnu

              echo '=== Setting up build dependencies ==='
              apt-get update
              apt-get install -y mingw-w64 protobuf-compiler cmake

              echo '=== Setting up cross-compilation environment ==='
              export CC_x86_64_pc_windows_gnu=x86_64-w64-mingw32-gcc
              export CXX_x86_64_pc_windows_gnu=x86_64-w64-mingw32-g++
              export AR_x86_64_pc_windows_gnu=x86_64-w64-mingw32-ar
              export CARGO_TARGET_X86_64_PC_WINDOWS_GNU_LINKER=x86_64-w64-mingw32-gcc
              export PKG_CONFIG_ALLOW_CROSS=1
              export PROTOC=/usr/bin/protoc

              echo '=== Cargo configuration ==='
              mkdir -p .cargo
              cat > .cargo/config.toml << 'CARGO_CONFIG'
          [build]
          jobs = 4

          [target.x86_64-pc-windows-gnu]
          linker = \"x86_64-w64-mingw32-gcc\"

          [net]
          git-fetch-with-cli = true
          retry = 3

          [profile.release]
          codegen-units = 1
          lto = false
          panic = \"abort\"
          debug = false
          opt-level = 2

          [registries.crates-io]
          protocol = \"sparse\"
          CARGO_CONFIG

              echo 'ðŸ”¨ Building Windows executable...'
              cargo build --release --target x86_64-pc-windows-gnu -p goose-server --jobs 4

              echo '=== Copying Windows runtime DLLs ==='
              GCC_DIR=\$(ls -d /usr/lib/gcc/x86_64-w64-mingw32/*/ | head -n 1)
              cp \"\$GCC_DIR/libstdc++-6.dll\" target/x86_64-pc-windows-gnu/release/
              cp \"\$GCC_DIR/libgcc_s_seh-1.dll\" target/x86_64-pc-windows-gnu/release/
              cp /usr/x86_64-w64-mingw32/lib/libwinpthread-1.dll target/x86_64-pc-windows-gnu/release/

              echo 'âœ… Build completed successfully!'
              ls -la target/x86_64-pc-windows-gnu/release/goosed.exe
            "

          # Verify build succeeded
          if [ ! -f "./target/x86_64-pc-windows-gnu/release/goosed.exe" ]; then
            echo "âŒ Windows binary not found."
            exit 1
          fi
          echo "âœ… Windows binary found!"

      - name: Prepare Windows binary and DLLs
        run: |
          mkdir -p ./ui/desktop/src/bin
          cp -f ./target/x86_64-pc-windows-gnu/release/goosed.exe ./ui/desktop/src/bin/
          cp -f ./target/x86_64-pc-windows-gnu/release/*.dll ./ui/desktop/src/bin/
          echo "âœ… Binary and DLLs copied to Electron folder"
          ls -la ./ui/desktop/src/bin/

      - name: Install npm dependencies
        working-directory: ui/desktop
        run: npm ci

      - name: Update version (if specified)
        if: ${{ inputs.version != '' }}
        working-directory: ui/desktop
        run: npm version ${{ inputs.version }} --no-git-tag-version --allow-same-version

      - name: Build Electron App (Package)
        working-directory: ui/desktop
        run: npx electron-forge package --platform win32 --arch x64
        env:
          ELECTRON_PLATFORM: win32

      - name: Copy DLLs to output
        run: |
          mkdir -p ui/desktop/out/AGIME-win32-x64/resources/bin
          cp -f ./ui/desktop/src/bin/*.dll ui/desktop/out/AGIME-win32-x64/resources/bin/ || true
          cp -f ./ui/desktop/src/bin/goosed.exe ui/desktop/out/AGIME-win32-x64/resources/bin/ || true

      - name: Create ZIP archive
        working-directory: ui/desktop/out
        run: zip -r AGIME-win32-x64.zip AGIME-win32-x64

      - name: Upload Windows x64 ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: AGIME-win32-x64-zip
          path: ui/desktop/out/AGIME-win32-x64.zip
          retention-days: 30

  # ============================================
  # Windows Build (x64) - Squirrel Installer (Docker Cross-Compilation)
  # Note: Squirrel installer requires Windows runner, using ZIP instead
  # ============================================
  build-windows-x64-installer:
    runs-on: ubuntu-latest
    name: Build Windows (x64 Installer)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: ui/desktop/package-lock.json

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: windows-x64-installer

      - name: Build Windows executable using Docker cross-compilation
        run: |
          echo "ðŸš€ Building Windows executable with Docker cross-compilation..."

          mkdir -p ~/.cargo/registry ~/.cargo/git

          docker run --rm \
            -v "$(pwd)":/usr/src/myapp \
            -v "$HOME/.cargo/registry":/usr/local/cargo/registry \
            -v "$HOME/.cargo/git":/usr/local/cargo/git \
            -w /usr/src/myapp \
            rust:latest \
            bash -c "
              set -e
              export CARGO_HOME=/usr/local/cargo
              export PATH=/usr/local/cargo/bin:\$PATH

              rustup target add x86_64-pc-windows-gnu

              apt-get update
              apt-get install -y mingw-w64 protobuf-compiler cmake

              export CC_x86_64_pc_windows_gnu=x86_64-w64-mingw32-gcc
              export CXX_x86_64_pc_windows_gnu=x86_64-w64-mingw32-g++
              export AR_x86_64_pc_windows_gnu=x86_64-w64-mingw32-ar
              export CARGO_TARGET_X86_64_PC_WINDOWS_GNU_LINKER=x86_64-w64-mingw32-gcc
              export PKG_CONFIG_ALLOW_CROSS=1
              export PROTOC=/usr/bin/protoc

              mkdir -p .cargo
              cat > .cargo/config.toml << 'CARGO_CONFIG'
          [build]
          jobs = 4

          [target.x86_64-pc-windows-gnu]
          linker = \"x86_64-w64-mingw32-gcc\"

          [net]
          git-fetch-with-cli = true
          retry = 3

          [profile.release]
          codegen-units = 1
          lto = false
          panic = \"abort\"
          debug = false
          opt-level = 2

          [registries.crates-io]
          protocol = \"sparse\"
          CARGO_CONFIG

              cargo build --release --target x86_64-pc-windows-gnu -p goose-server --jobs 4

              GCC_DIR=\$(ls -d /usr/lib/gcc/x86_64-w64-mingw32/*/ | head -n 1)
              cp \"\$GCC_DIR/libstdc++-6.dll\" target/x86_64-pc-windows-gnu/release/
              cp \"\$GCC_DIR/libgcc_s_seh-1.dll\" target/x86_64-pc-windows-gnu/release/
              cp /usr/x86_64-w64-mingw32/lib/libwinpthread-1.dll target/x86_64-pc-windows-gnu/release/
            "

          if [ ! -f "./target/x86_64-pc-windows-gnu/release/goosed.exe" ]; then
            echo "âŒ Windows binary not found."
            exit 1
          fi

      - name: Prepare Windows binary and DLLs
        run: |
          mkdir -p ./ui/desktop/src/bin
          cp -f ./target/x86_64-pc-windows-gnu/release/goosed.exe ./ui/desktop/src/bin/
          cp -f ./target/x86_64-pc-windows-gnu/release/*.dll ./ui/desktop/src/bin/

      - name: Install npm dependencies
        working-directory: ui/desktop
        run: npm ci

      - name: Update version (if specified)
        if: ${{ inputs.version != '' }}
        working-directory: ui/desktop
        run: npm version ${{ inputs.version }} --no-git-tag-version --allow-same-version

      - name: Build Electron App (Package for Installer)
        working-directory: ui/desktop
        run: npx electron-forge package --platform win32 --arch x64
        env:
          ELECTRON_PLATFORM: win32

      - name: Copy DLLs to output
        run: |
          mkdir -p ui/desktop/out/AGIME-win32-x64/resources/bin
          cp -f ./ui/desktop/src/bin/*.dll ui/desktop/out/AGIME-win32-x64/resources/bin/ || true
          cp -f ./ui/desktop/src/bin/goosed.exe ui/desktop/out/AGIME-win32-x64/resources/bin/ || true

      - name: Create Installer ZIP archive
        working-directory: ui/desktop/out
        run: zip -r AGIME-win32-x64-installer.zip AGIME-win32-x64

      - name: Upload Windows x64 Installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: AGIME-win32-x64-installer
          path: ui/desktop/out/AGIME-win32-x64-installer.zip
          retention-days: 30

  # ============================================
  # macOS Build (ARM64 - Apple Silicon) - ZIP
  # ============================================
  build-macos-arm64:
    runs-on: macos-latest
    name: Build macOS (ARM64 ZIP)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: ui/desktop/package-lock.json

      - name: Build goosed (Release)
        run: cargo build --release -p goose-server

      - name: Copy binary to Electron folder
        run: |
          mkdir -p ui/desktop/src/bin
          cp target/release/goosed ui/desktop/src/bin/goosed

      - name: Install npm dependencies
        working-directory: ui/desktop
        run: npm ci

      - name: Update version (if specified)
        if: ${{ inputs.version != '' }}
        working-directory: ui/desktop
        run: npm version ${{ inputs.version }} --no-git-tag-version --allow-same-version

      - name: Build Electron App
        working-directory: ui/desktop
        run: npx electron-forge package --platform darwin --arch arm64

      - name: Create ZIP archive
        working-directory: ui/desktop/out/AGIME-darwin-arm64
        run: zip -r ../AGIME-darwin-arm64.zip AGIME.app

      - name: Upload macOS ARM64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: AGIME-darwin-arm64-zip
          path: ui/desktop/out/AGIME-darwin-arm64.zip
          retention-days: 30

      - name: Quick launch test
        run: |
          xattr -cr "ui/desktop/out/AGIME-darwin-arm64/AGIME.app"
          echo "Opening AGIME.app..."
          open -g "ui/desktop/out/AGIME-darwin-arm64/AGIME.app"
          sleep 5
          if pgrep -f "AGIME.app/Contents/MacOS/AGIME" > /dev/null; then
            echo "App is running successfully"
            pkill -f "AGIME.app/Contents/MacOS/AGIME"
          else
            echo "Warning: App may not have started properly"
          fi

  # ============================================
  # macOS Build (ARM64) - DMG Installer
  # ============================================
  build-macos-arm64-dmg:
    runs-on: macos-latest
    name: Build macOS (ARM64 DMG)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: ui/desktop/package-lock.json

      - name: Build goosed (Release)
        run: cargo build --release -p goose-server

      - name: Copy binary to Electron folder
        run: |
          mkdir -p ui/desktop/src/bin
          cp target/release/goosed ui/desktop/src/bin/goosed

      - name: Install npm dependencies
        working-directory: ui/desktop
        run: npm ci

      - name: Install create-dmg
        run: npm install -g create-dmg || brew install create-dmg

      - name: Update version (if specified)
        if: ${{ inputs.version != '' }}
        working-directory: ui/desktop
        run: npm version ${{ inputs.version }} --no-git-tag-version --allow-same-version

      - name: Build Electron App (Package)
        working-directory: ui/desktop
        run: npx electron-forge package --platform darwin --arch arm64

      - name: Create DMG
        working-directory: ui/desktop/out
        run: |
          create-dmg \
            --volname "AGIME Installer" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "AGIME.app" 150 190 \
            --app-drop-link 450 190 \
            "AGIME-darwin-arm64.dmg" \
            "AGIME-darwin-arm64/AGIME.app" || true

      - name: Upload macOS ARM64 DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: AGIME-darwin-arm64-dmg
          path: ui/desktop/out/AGIME-darwin-arm64.dmg
          retention-days: 30
          if-no-files-found: warn

  # ============================================
  # macOS Build (x64 - Intel) - ZIP
  # ============================================
  build-macos-x64:
    runs-on: macos-15
    name: Build macOS (x64 Intel ZIP)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: ui/desktop/package-lock.json

      - name: Build goosed (Release)
        run: cargo build --release -p goose-server

      - name: Copy binary to Electron folder
        run: |
          mkdir -p ui/desktop/src/bin
          cp target/release/goosed ui/desktop/src/bin/goosed

      - name: Install npm dependencies
        working-directory: ui/desktop
        run: npm ci

      - name: Update version (if specified)
        if: ${{ inputs.version != '' }}
        working-directory: ui/desktop
        run: npm version ${{ inputs.version }} --no-git-tag-version --allow-same-version

      - name: Build Electron App
        working-directory: ui/desktop
        run: |
          npx electron-forge package --platform darwin --arch x64

      - name: Create ZIP archive
        working-directory: ui/desktop/out/AGIME-darwin-x64
        run: zip -r ../AGIME-darwin-x64.zip AGIME.app

      - name: Upload macOS x64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: AGIME-darwin-x64-zip
          path: ui/desktop/out/AGIME-darwin-x64.zip
          retention-days: 30

  # ============================================
  # macOS Build (x64 Intel) - DMG Installer
  # ============================================
  build-macos-x64-dmg:
    runs-on: macos-15
    name: Build macOS (x64 Intel DMG)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: ui/desktop/package-lock.json

      - name: Build goosed (Release)
        run: cargo build --release -p goose-server

      - name: Copy binary to Electron folder
        run: |
          mkdir -p ui/desktop/src/bin
          cp target/release/goosed ui/desktop/src/bin/goosed

      - name: Install npm dependencies
        working-directory: ui/desktop
        run: npm ci

      - name: Install create-dmg
        run: npm install -g create-dmg || brew install create-dmg

      - name: Update version (if specified)
        if: ${{ inputs.version != '' }}
        working-directory: ui/desktop
        run: npm version ${{ inputs.version }} --no-git-tag-version --allow-same-version

      - name: Build Electron App (Package)
        working-directory: ui/desktop
        run: npx electron-forge package --platform darwin --arch x64

      - name: Create DMG
        working-directory: ui/desktop/out
        run: |
          create-dmg \
            --volname "AGIME Installer" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "AGIME.app" 150 190 \
            --app-drop-link 450 190 \
            "AGIME-darwin-x64.dmg" \
            "AGIME-darwin-x64/AGIME.app" || true

      - name: Upload macOS x64 DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: AGIME-darwin-x64-dmg
          path: ui/desktop/out/AGIME-darwin-x64.dmg
          retention-days: 30
          if-no-files-found: warn

  # ============================================
  # Linux Build (x64) - tar.gz
  # ============================================
  build-linux-x64:
    runs-on: ubuntu-latest
    name: Build Linux (x64 tar.gz)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libxdo-dev \
            libssl-dev \
            libasound2-dev

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: ui/desktop/package-lock.json

      - name: Build goosed (Release)
        run: cargo build --release -p goose-server

      - name: Copy binary to Electron folder
        run: |
          mkdir -p ui/desktop/src/bin
          cp target/release/goosed ui/desktop/src/bin/goosed

      - name: Install npm dependencies
        working-directory: ui/desktop
        run: npm ci

      - name: Update version (if specified)
        if: ${{ inputs.version != '' }}
        working-directory: ui/desktop
        run: npm version ${{ inputs.version }} --no-git-tag-version --allow-same-version

      - name: Build Electron App
        working-directory: ui/desktop
        run: |
          npx electron-forge package --platform linux --arch x64

      - name: Create tar.gz archive
        working-directory: ui/desktop/out
        run: tar -czvf AGIME-linux-x64.tar.gz AGIME-linux-x64

      - name: Upload Linux x64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: AGIME-linux-x64-tar
          path: ui/desktop/out/AGIME-linux-x64.tar.gz
          retention-days: 30

  # ============================================
  # Linux Build (x64) - DEB Package
  # ============================================
  build-linux-x64-deb:
    runs-on: ubuntu-latest
    name: Build Linux (x64 DEB)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libxdo-dev \
            libssl-dev \
            libasound2-dev \
            dpkg \
            fakeroot

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: ui/desktop/package-lock.json

      - name: Build goosed (Release)
        run: cargo build --release -p goose-server

      - name: Copy binary to Electron folder
        run: |
          mkdir -p ui/desktop/src/bin
          cp target/release/goosed ui/desktop/src/bin/goosed

      - name: Install npm dependencies
        working-directory: ui/desktop
        run: npm ci

      - name: Update version (if specified)
        if: ${{ inputs.version != '' }}
        working-directory: ui/desktop
        run: npm version ${{ inputs.version }} --no-git-tag-version --allow-same-version

      - name: Build DEB Package
        working-directory: ui/desktop
        run: |
          npx electron-forge make --platform linux --arch x64 --targets @electron-forge/maker-deb

      - name: Upload Linux x64 DEB artifact
        uses: actions/upload-artifact@v4
        with:
          name: AGIME-linux-x64-deb
          path: ui/desktop/out/make/deb/x64/*.deb
          retention-days: 30

  # ============================================
  # Linux Build (x64) - RPM Package
  # ============================================
  build-linux-x64-rpm:
    runs-on: ubuntu-latest
    name: Build Linux (x64 RPM)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libxdo-dev \
            libssl-dev \
            libasound2-dev \
            rpm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: ui/desktop/package-lock.json

      - name: Build goosed (Release)
        run: cargo build --release -p goose-server

      - name: Copy binary to Electron folder
        run: |
          mkdir -p ui/desktop/src/bin
          cp target/release/goosed ui/desktop/src/bin/goosed

      - name: Install npm dependencies
        working-directory: ui/desktop
        run: npm ci

      - name: Update version (if specified)
        if: ${{ inputs.version != '' }}
        working-directory: ui/desktop
        run: npm version ${{ inputs.version }} --no-git-tag-version --allow-same-version

      - name: Build RPM Package
        working-directory: ui/desktop
        run: |
          npx electron-forge make --platform linux --arch x64 --targets @electron-forge/maker-rpm

      - name: Upload Linux x64 RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: AGIME-linux-x64-rpm
          path: ui/desktop/out/make/rpm/x64/*.rpm
          retention-days: 30

  # ============================================
  # Linux Build (ARM64) - tar.gz
  # ============================================
  build-linux-arm64:
    runs-on: ubuntu-24.04-arm
    name: Build Linux (ARM64 tar.gz)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libxdo-dev \
            libssl-dev \
            libasound2-dev

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: ui/desktop/package-lock.json

      - name: Build goosed (Release)
        run: cargo build --release -p goose-server

      - name: Copy binary to Electron folder
        run: |
          mkdir -p ui/desktop/src/bin
          cp target/release/goosed ui/desktop/src/bin/goosed

      - name: Install npm dependencies
        working-directory: ui/desktop
        run: npm ci

      - name: Update version (if specified)
        if: ${{ inputs.version != '' }}
        working-directory: ui/desktop
        run: npm version ${{ inputs.version }} --no-git-tag-version --allow-same-version

      - name: Build Electron App
        working-directory: ui/desktop
        run: |
          npx electron-forge package --platform linux --arch arm64

      - name: Create tar.gz archive
        working-directory: ui/desktop/out
        run: tar -czvf AGIME-linux-arm64.tar.gz AGIME-linux-arm64

      - name: Upload Linux ARM64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: AGIME-linux-arm64-tar
          path: ui/desktop/out/AGIME-linux-arm64.tar.gz
          retention-days: 30

  # ============================================
  # Linux Build (ARM64) - DEB Package
  # ============================================
  build-linux-arm64-deb:
    runs-on: ubuntu-24.04-arm
    name: Build Linux (ARM64 DEB)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libxdo-dev \
            libssl-dev \
            libasound2-dev \
            dpkg \
            fakeroot

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: ui/desktop/package-lock.json

      - name: Build goosed (Release)
        run: cargo build --release -p goose-server

      - name: Copy binary to Electron folder
        run: |
          mkdir -p ui/desktop/src/bin
          cp target/release/goosed ui/desktop/src/bin/goosed

      - name: Install npm dependencies
        working-directory: ui/desktop
        run: npm ci

      - name: Update version (if specified)
        if: ${{ inputs.version != '' }}
        working-directory: ui/desktop
        run: npm version ${{ inputs.version }} --no-git-tag-version --allow-same-version

      - name: Build DEB Package
        working-directory: ui/desktop
        run: |
          npx electron-forge make --platform linux --arch arm64 --targets @electron-forge/maker-deb

      - name: Upload Linux ARM64 DEB artifact
        uses: actions/upload-artifact@v4
        with:
          name: AGIME-linux-arm64-deb
          path: ui/desktop/out/make/deb/arm64/*.deb
          retention-days: 30

  # ============================================
  # Linux Build (ARM64) - RPM Package
  # ============================================
  build-linux-arm64-rpm:
    runs-on: ubuntu-24.04-arm
    name: Build Linux (ARM64 RPM)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libxdo-dev \
            libssl-dev \
            libasound2-dev \
            rpm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: ui/desktop/package-lock.json

      - name: Build goosed (Release)
        run: cargo build --release -p goose-server

      - name: Copy binary to Electron folder
        run: |
          mkdir -p ui/desktop/src/bin
          cp target/release/goosed ui/desktop/src/bin/goosed

      - name: Install npm dependencies
        working-directory: ui/desktop
        run: npm ci

      - name: Update version (if specified)
        if: ${{ inputs.version != '' }}
        working-directory: ui/desktop
        run: npm version ${{ inputs.version }} --no-git-tag-version --allow-same-version

      - name: Build RPM Package
        working-directory: ui/desktop
        run: |
          npx electron-forge make --platform linux --arch arm64 --targets @electron-forge/maker-rpm

      - name: Upload Linux ARM64 RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: AGIME-linux-arm64-rpm
          path: ui/desktop/out/make/rpm/arm64/*.rpm
          retention-days: 30

  # ============================================
  # Create Release (on tags or manual trigger)
  # ============================================
  create-release:
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && inputs.create_release == true)
    needs:
      - build-windows-x64
      - build-windows-x64-installer
      - build-macos-arm64
      - build-macos-arm64-dmg
      - build-macos-x64
      - build-macos-x64-dmg
      - build-linux-x64
      - build-linux-x64-deb
      - build-linux-x64-rpm
      - build-linux-arm64
      - build-linux-arm64-deb
      - build-linux-arm64-rpm
    runs-on: ubuntu-latest
    name: Create GitHub Release

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: |
          echo "=== All artifacts ==="
          find artifacts -type f -name "*.*" | head -50
          echo ""
          echo "=== Directory structure ==="
          ls -laR artifacts/

      - name: Determine release tag
        id: release_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ inputs.release_tag }}"
            if [ -z "$TAG" ]; then
              TAG="v1.0.0-$(date +%Y%m%d)"
            fi
          else
            TAG="${{ github.ref_name }}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_tag.outputs.tag }}
          name: AGIME ${{ steps.release_tag.outputs.tag }}
          fail_on_unmatched_files: false
          files: |
            artifacts/AGIME-win32-x64-zip/AGIME-win32-x64.zip
            artifacts/AGIME-win32-x64-installer/AGIME-win32-x64-installer.zip
            artifacts/AGIME-darwin-arm64-zip/AGIME-darwin-arm64.zip
            artifacts/AGIME-darwin-arm64-dmg/*.dmg
            artifacts/AGIME-darwin-x64-zip/AGIME-darwin-x64.zip
            artifacts/AGIME-darwin-x64-dmg/*.dmg
            artifacts/AGIME-linux-x64-tar/AGIME-linux-x64.tar.gz
            artifacts/AGIME-linux-x64-deb/*.deb
            artifacts/AGIME-linux-x64-rpm/*.rpm
            artifacts/AGIME-linux-arm64-tar/AGIME-linux-arm64.tar.gz
            artifacts/AGIME-linux-arm64-deb/*.deb
            artifacts/AGIME-linux-arm64-rpm/*.rpm
          draft: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
